CKEDITOR.plugins.add('esp_link',{lang:['en','ru','uk'],init:function(e){e.addCommand('esp_link',new CKEDITOR.dialogCommand('esp_link'));e.addCommand('esp_anchor',new CKEDITOR.dialogCommand('esp_anchor'));e.addCommand('unlink',new CKEDITOR.unlinkCommand());e.addCommand('removeAnchor',new CKEDITOR.removeAnchorCommand());e.ui.addButton('Esp_link',{label:e.lang.link.toolbar,command:'esp_link',icon:this.path+"images/esp_link.png"});e.ui.addButton('Esp_unlink',{label:e.lang.unlink,command:'unlink',icon:this.path+"images/esp_unlink.png"});e.ui.addButton('Esp_anchor',{label:e.lang.anchor.toolbar,command:'esp_anchor',icon:this.path+"images/esp_anchor.png"});CKEDITOR.dialog.add('esp_link',this.path+'dialogs/esp_link.js');CKEDITOR.dialog.add('esp_anchor',this.path+'dialogs/esp_anchor.js');var f=(e.lang.dir=='rtl'?'right':'left');var g='background:url('+CKEDITOR.getUrl(this.path+'images/anchor.png')+') no-repeat '+f+' center;'+'border:1px dotted #00f;';e.addCss('a.cke_anchor,a.cke_anchor_empty'+((CKEDITOR.env.ie&&CKEDITOR.env.version<7)?'':',a[name],a[data-cke-saved-name]')+'{'+g+'padding-'+f+':18px;'+'cursor:auto;'+'}'+(CKEDITOR.env.ie?('a.cke_anchor_empty'+'{'+'display:inline-block;'+'}'):'')+'img.cke_anchor'+'{'+g+'width:16px;'+'min-height:15px;'+'height:1.15em;'+'vertical-align:'+(CKEDITOR.env.opera?'middle':'text-bottom')+';'+'}');e.on('selectionChange',function(a){if(e.readOnly)return;var b=e.getCommand('unlink'),element=a.data.path.lastElement&&a.data.path.lastElement.getAscendant('a',true);if(element&&element.getName()=='a'&&element.getAttribute('href')&&element.getChildCount())b.setState(CKEDITOR.TRISTATE_OFF);else b.setState(CKEDITOR.TRISTATE_DISABLED)});e.on('doubleclick',function(a){var b=CKEDITOR.plugins.esp_link.getSelectedLink(e)||a.data.element;if(!b.isReadOnly()){if(b.is('a')){a.data.dialog=(b.getAttribute('name')&&(!b.getAttribute('href')||!b.getChildCount()))?'anchor':'link';e.getSelection().selectElement(b)}else if(CKEDITOR.plugins.esp_link.tryRestoreFakeAnchor(e,b))a.data.dialog='anchor'}});if(e.addMenuItems){e.addMenuItems({anchor:{label:e.lang.anchor.menu,command:'anchor',group:'anchor',order:1},removeAnchor:{label:e.lang.anchor.remove,command:'removeAnchor',group:'anchor',order:5},link:{label:e.lang.link.menu,command:'link',group:'link',order:1},unlink:{label:e.lang.unlink,command:'unlink',group:'link',order:5}})}if(e.contextMenu){e.contextMenu.addListener(function(a,b){if(!a||a.isReadOnly())return null;var c=CKEDITOR.plugins.esp_link.tryRestoreFakeAnchor(e,a);if(!c&&!(c=CKEDITOR.plugins.esp_link.getSelectedLink(e)))return null;var d={};if(c.getAttribute('href')&&c.getChildCount())d={link:CKEDITOR.TRISTATE_OFF,unlink:CKEDITOR.TRISTATE_OFF};if(c&&c.hasAttribute('name'))d.anchor=d.removeAnchor=CKEDITOR.TRISTATE_OFF;return d})}},afterInit:function(f){var g=f.dataProcessor,dataFilter=g&&g.dataFilter,htmlFilter=g&&g.htmlFilter,pathFilters=f._.elementsPath&&f._.elementsPath.filters;if(dataFilter){dataFilter.addRules({elements:{a:function(a){var b=a.attributes;if(!b.name)return null;var c=!a.children.length;if(CKEDITOR.plugins.esp_link.synAnchorSelector){var d=c?'cke_anchor_empty':'cke_anchor';var e=b['class'];if(b.name&&(!e||e.indexOf(d)<0))b['class']=(e||'')+' '+d;if(c&&CKEDITOR.plugins.esp_link.emptyAnchorFix){b.contenteditable='false';b['data-cke-editable']=1}}else if(CKEDITOR.plugins.esp_link.fakeAnchor&&c)return f.createFakeParserElement(a,'cke_anchor','anchor');return null}}})}if(CKEDITOR.plugins.esp_link.emptyAnchorFix&&htmlFilter){htmlFilter.addRules({elements:{a:function(a){delete a.attributes.contenteditable}}})}if(pathFilters){pathFilters.push(function(a,b){if(b=='a'){if(CKEDITOR.plugins.esp_link.tryRestoreFakeAnchor(f,a)||(a.getAttribute('name')&&(!a.getAttribute('href')||!a.getChildCount()))){return'anchor'}}})}},requires:['fakeobjects']});CKEDITOR.plugins.esp_link={getSelectedLink:function(a){try{var b=a.getSelection();if(b.getType()==CKEDITOR.SELECTION_ELEMENT){var c=b.getSelectedElement();if(c.is('a'))return c}var d=b.getRanges(true)[0];d.shrink(CKEDITOR.SHRINK_TEXT);var f=d.getCommonAncestor();return f.getAscendant('a',true)}catch(e){return null}},fakeAnchor:CKEDITOR.env.opera||CKEDITOR.env.webkit,synAnchorSelector:CKEDITOR.env.ie,emptyAnchorFix:CKEDITOR.env.ie&&CKEDITOR.env.version<8,tryRestoreFakeAnchor:function(a,b){if(b&&b.data('cke-real-element-type')&&b.data('cke-real-element-type')=='anchor'){var c=a.restoreRealElement(b);if(c.data('cke-saved-name'))return c}}};CKEDITOR.unlinkCommand=function(){};CKEDITOR.unlinkCommand.prototype={exec:function(a){var b=a.getSelection(),bookmarks=b.createBookmarks(),ranges=b.getRanges(),rangeRoot,element;for(var i=0;i<ranges.length;i++){rangeRoot=ranges[i].getCommonAncestor(true);element=rangeRoot.getAscendant('a',true);if(!element)continue;ranges[i].selectNodeContents(element)}b.selectRanges(ranges);a.document.$.execCommand('unlink',false,null);b.selectBookmarks(bookmarks)},startDisabled:true};CKEDITOR.removeAnchorCommand=function(){};CKEDITOR.removeAnchorCommand.prototype={exec:function(a){var b=a.getSelection(),bms=b.createBookmarks(),anchor;if(b&&(anchor=b.getSelectedElement())&&(CKEDITOR.plugins.esp_link.fakeAnchor&&!anchor.getChildCount()?CKEDITOR.plugins.esp_link.tryRestoreFakeAnchor(a,anchor):anchor.is('a')))anchor.remove(1);else{if((anchor=CKEDITOR.plugins.esp_link.getSelectedLink(a))){if(anchor.hasAttribute('href')){anchor.removeAttributes({name:1,'data-cke-saved-name':1});anchor.removeClass('cke_anchor')}else anchor.remove(1)}}b.selectBookmarks(bms)}};CKEDITOR.tools.extend(CKEDITOR.config,{linkShowAdvancedTab:true,linkShowTargetTab:true});

